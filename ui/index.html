<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CPU Scheduling Visualizer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/htm@3.1.1/dist/htm.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold">CPU Scheduling Visualizer</h1>
        <p class="text-sm text-slate-600">Compare FCFS, RR, SPN, SRT, HRRN, FB-1, FB-2i, Aging</p>
      </div>
      <a href="https://github.com" target="_blank" class="text-sm text-blue-600 hover:underline">Docs</a>
    </header>

    <section class="bg-white rounded-xl shadow p-5 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1">Algorithms</label>
          <input id="algos" type="text" class="w-full rounded border-slate-300 focus:border-blue-500 focus:ring-blue-500" placeholder="1,2-4,3" value="1,2-4,3" />
          <p class="text-xs text-slate-500 mt-1">Use numbers with optional -q for quantum. Example: 1,2-4,3,4,5,6,7,8-1</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Last Instant</label>
          <input id="lastInstant" type="number" min="1" class="w-full rounded border-slate-300 focus:border-blue-500 focus:ring-blue-500" value="20" />
        </div>
        <div class="flex items-end">
          <button id="runBtn" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-blue-600 text-white px-4 py-2 hover:bg-blue-700 active:bg-blue-800">Run</button>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Processes</label>
        <div id="processList" class="space-y-2"></div>
        <div class="flex gap-2 mt-2">
          <button id="addProc" class="text-sm px-3 py-1.5 bg-slate-100 rounded hover:bg-slate-200">Add process</button>
          <button id="loadSample" class="text-sm px-3 py-1.5 bg-slate-100 rounded hover:bg-slate-200">Load sample</button>
        </div>
      </div>
    </section>

    <section id="results" class="hidden bg-white rounded-xl shadow p-5 space-y-6">
      <div id="stats" class="overflow-x-auto"></div>
      <div id="timelines" class="overflow-x-auto space-y-8"></div>
    </section>
  </div>

  <template id="procRowTmpl">
    <div class="grid grid-cols-12 gap-2 items-center">
      <input placeholder="Name" class="col-span-4 rounded border-slate-300 focus:border-blue-500 focus:ring-blue-500" />
      <input type="number" min="0" placeholder="Arrival" class="col-span-4 rounded border-slate-300 focus:border-blue-500 focus:ring-blue-500" />
      <input type="number" min="0" placeholder="Service/Priority" class="col-span-3 rounded border-slate-300 focus:border-blue-500 focus:ring-blue-500" />
      <button class="col-span-1 text-red-600 hover:text-red-700" title="Remove">âœ•</button>
    </div>
  </template>

  <script>
    const processList = document.getElementById('processList');
    const tmpl = document.getElementById('procRowTmpl');

    function addRow(name = '', arrival = 0, value = 1) {
      const node = tmpl.content.cloneNode(true);
      const [nameI, arrI, svcI, remBtn] = node.querySelectorAll('input,button');
      nameI.value = name; arrI.value = arrival; svcI.value = value;
      remBtn.addEventListener('click', () => remBtn.closest('.grid').remove());
      processList.appendChild(node);
    }

    function loadSample() {
      processList.innerHTML = '';
      addRow('P1', 0, 3);
      addRow('P2', 2, 5);
      addRow('P3', 3, 2);
    }

    document.getElementById('addProc').addEventListener('click', () => addRow());
    document.getElementById('loadSample').addEventListener('click', loadSample);
    loadSample();

    async function run() {
      const algos = document.getElementById('algos').value.trim();
      const lastInstant = parseInt(document.getElementById('lastInstant').value, 10) || 20;
      const rows = [...processList.querySelectorAll('.grid')];
      const processes = rows.map(row => {
        const [n,a,s] = row.querySelectorAll('input');
        return `${(n.value||'P')},${parseInt(a.value,10)||0},${parseInt(s.value,10)||1}`;
      });

      const res = await fetch('/api/run', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ algos, lastInstant, processes })
      });
      if (!res.ok) {
        const err = await res.json().catch(()=>({detail:'Unknown error'}));
        alert('Error: ' + (err.detail || res.statusText));
        return;
      }
      const data = await res.json();
      renderResults(data);
    }

    document.getElementById('runBtn').addEventListener('click', run);

    function renderResults(data) {
      document.getElementById('results').classList.remove('hidden');
      const statsDiv = document.getElementById('stats');
      const timelinesDiv = document.getElementById('timelines');
      statsDiv.innerHTML = '';
      timelinesDiv.innerHTML = '';

      // processes header
      const header = document.createElement('div');
      header.className = 'text-sm text-slate-700';
      header.textContent = `lastInstant: ${data.lastInstant}, processCount: ${data.processCount}`;
      statsDiv.appendChild(header);

      // For each algorithm: timeline + stats
      data.results.forEach((res, idx) => {
        const card = document.createElement('div');
        card.className = 'border border-slate-200 rounded-lg p-4';

        const title = document.createElement('div');
        title.className = 'font-semibold mb-2';
        title.textContent = res.algorithm;
        card.appendChild(title);

        // Stats table
        const statsTable = document.createElement('div');
        statsTable.className = 'overflow-x-auto';
        statsTable.innerHTML = `
          <table class="min-w-[480px] w-full text-sm">
            <thead>
              <tr class="text-left text-slate-600">
                <th class="py-1 pr-4">Process</th>
                <th class="py-1 pr-4">Finish</th>
                <th class="py-1 pr-4">Turnaround</th>
                <th class="py-1 pr-4">NormTurn</th>
              </tr>
            </thead>
            <tbody>
              ${res.timeline.map((row, i) => `
                <tr class="border-t border-slate-100">
                  <td class="py-1 pr-4">${row.process}</td>
                  <td class="py-1 pr-4">${res.finishTime[i]}</td>
                  <td class="py-1 pr-4">${res.turnAroundTime[i]}</td>
                  <td class="py-1 pr-4">${Number(res.normTurn[i]).toFixed(2)}</td>
                </tr>
              `).join('')}
              <tr class="border-t-2 border-slate-200 font-medium">
                <td class="py-1 pr-4">Mean</td>
                <td class="py-1 pr-4">-</td>
                <td class="py-1 pr-4">${Number(res.meanTurnAround).toFixed(2)}</td>
                <td class="py-1 pr-4">${Number(res.meanNormTurn).toFixed(2)}</td>
              </tr>
            </tbody>
          </table>
        `;
        card.appendChild(statsTable);

        // Timeline grid
        const grid = document.createElement('div');
        grid.className = 'mt-4';
        const cols = data.lastInstant;
        const cellW = 22; // px
        const legend = document.createElement('div');
        legend.className = 'text-xs text-slate-600 mb-2';
        legend.innerHTML = `<span class="inline-block w-3 h-3 bg-emerald-500 mr-1"></span>Run (*) <span class="ml-3 inline-block w-3 h-3 bg-amber-400 mr-1"></span>Wait (.) <span class="ml-3 inline-block w-3 h-3 bg-slate-200 mr-1"></span>Idle ( )`;
        grid.appendChild(legend);

        const container = document.createElement('div');
        container.className = 'space-y-2';

        res.timeline.forEach((row) => {
          const rowEl = document.createElement('div');
          rowEl.className = 'flex items-center gap-2';
          const label = document.createElement('div');
          label.className = 'w-14 text-xs text-slate-700';
          label.textContent = row.process;
          rowEl.appendChild(label);

          const track = document.createElement('div');
          track.className = 'flex rounded overflow-hidden border border-slate-200';
          track.style.width = (cols * (cellW/2)) + 'px';

          for (let i=0; i<row.slots.length; i++) {
            const c = row.slots[i];
            const cell = document.createElement('div');
            cell.style.width = (cellW/2) + 'px';
            cell.style.height = '14px';
            cell.title = `t=${i}`;
            if (c === '*') cell.className = 'bg-emerald-500';
            else if (c === '.') cell.className = 'bg-amber-400';
            else cell.className = 'bg-slate-200';
            track.appendChild(cell);
          }

          rowEl.appendChild(track);
          container.appendChild(rowEl);
        });

        grid.appendChild(container);
        card.appendChild(grid);

        timelinesDiv.appendChild(card);
      });
    }
  </script>
</body>
</html>